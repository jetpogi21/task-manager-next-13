//Generated by WriteToModelfilterform_tsx - ModelFilterForm.tsx
"use client";
import { useTaskStore } from "@/hooks/tasks/useTaskStore";
import {
  TaskFormikFilter,
  TaskSearchParams,
} from "@/interfaces/TaskInterfaces";
import { DEFAULT_LIMIT } from "@/utils/constants";
import { getFilterValueFromURL, getParamsObject } from "@/utils/utilities";
import { encodeParams } from "@/utils/utils";
import { Form, Formik, FormikHelpers, FormikProps } from "formik";
import React, { MouseEventHandler } from "react";
import {
  DEFAULT_FILTERS,
  CONTROL_OPTIONS,
} from "@/utils/constants/TaskConstants";
import LimitSelector from "@/components/form/LimitSelector";
import { useURL } from "@/hooks/useURL";
import FormikControl from "@/components/form/FormikControl";
import { Button } from "@/components/ui/Button";
import { isEqual } from "lodash";
import { useTaskPageParams } from "@/hooks/tasks/useTaskPageParams";
//Generated by ImportAllUseModelListHookBySeqModel
import useTaskCategoryList from "@/hooks/task-categories/useTaskCategoryList"; //Generated by ImportUseModelListHook - ImportUseModelListHook
import useTaskIntervalList from "@/hooks/task-intervals/useTaskIntervalList"; //Generated by ImportUseModelListHook - ImportUseModelListHook

const TaskFilterForm: React.FC = () => {
  const { query, router, pathname, params } = useTaskPageParams();
  const { limit } = params;

  const defaultFilters = DEFAULT_FILTERS;
  const initialValues: TaskFormikFilter = getFilterValueFromURL(
    query,
    defaultFilters
  );

  //Tanstack queries
  //Generated by GetRequiredQueryFromTanstackBySeqModel
  //Generated by GetRequiredQueryFromTanstack
  const { data: taskCategoryList } = useTaskCategoryList();
  //Generated by GetRequiredQueryFromTanstack
  const { data: taskIntervalList } = useTaskIntervalList();

  //Zustand stores
  const [setPage, setLastFetchedPage, setFetchCount, resetRowSelection] =
    useTaskStore((state) => [
      state.setPage,
      state.setLastFetchedPage,
      state.setFetchCount,
      state.resetRowSelection,
    ]);

  const handleFormikSubmit = (
    values: Partial<TaskFormikFilter>,
    formik: FormikHelpers<TaskFormikFilter>
  ) => {
    const params = {
      ...query,
      ...(getParamsObject(values, defaultFilters) as Partial<TaskSearchParams>),
    };

    setFetchCount(true);
    setPage(1);
    setLastFetchedPage(1);
    resetRowSelection();
    const newURL = `${pathname}?${encodeParams(params)}`;
    router.push(newURL);
  };

  const handleLimitChange = (value: string) => {
    const params = { ...query, limit: value };
    const newURL = `${pathname}?${encodeParams(params)}`;
    router.push(newURL);
    resetRowSelection();
  };

  const renderFormik = (formik: FormikProps<TaskFormikFilter>) => {
    const filtered = isEqual(defaultFilters, formik.values);

    const handleSubmitClick: MouseEventHandler = (e) => {
      e.preventDefault();
      formik.submitForm();
    };

    const handleClearClick: MouseEventHandler = (e) => {
      e.preventDefault();
      formik.setValues(defaultFilters as TaskFormikFilter);
      formik.submitForm();
    };

    return (
      <Form
        className="flex gap-2 w-[750px]"
        autoComplete="off"
      >
        {/* Generated by GetFormikFilterQControl - GetFormikFilterQControl */}
        <FormikControl
          name="q"
          placeholder="Filter Tasks..."
          type="Text"
        />
        {/* Generated by GetAllFormikFilterControlBySeqModel */}
        {/* Generated by GetSelectFilter */}
        <FormikControl
          name="status"
          options={CONTROL_OPTIONS.status}
          label="Status"
          type="Select"
          showLabel={false}
          allowBlank={true}
        />
        {/* Generated by GetSelectFilter */}
        <FormikControl
          name="taskCategory"
          options={taskCategoryList || []}
          label="Task Category"
          type="Select"
          showLabel={false}
          allowBlank={true}
        />
        {/* Generated by GetSelectFilter */}
        <FormikControl
          name="taskInterval"
          options={taskIntervalList || []}
          label="Task Interval"
          type="Select"
          showLabel={false}
          allowBlank={true}
        />
        {/* Generated by GetFilterSwitchControl */}
        <FormikControl
          containerClassNames={["flex-row"]}
          name="hasFile"
          label="Has File"
          size="sm"
          type="Switch"
        />
        <Button
          type="button"
          onClick={handleSubmitClick}
          size={"sm"}
          variant={"secondary"}
        >
          Search
        </Button>
        <Button
          type="button"
          size={"sm"}
          variant={"ghost"}
          disabled={filtered}
          onClick={handleClearClick}
        >
          Clear
        </Button>
      </Form>
    );
  };

  return (
    <div className="flex justify-between w-full">
      <Formik
        initialValues={initialValues}
        onSubmit={handleFormikSubmit}
      >
        {renderFormik}
      </Formik>
      <LimitSelector
        handleLimitChange={handleLimitChange}
        value={limit}
      />
    </div>
  );
};

export default TaskFilterForm;
